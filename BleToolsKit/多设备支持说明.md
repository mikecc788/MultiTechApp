# 📱 多设备支持说明

## ✅ 当前封装完全支持多设备！

你的担心是不需要的！当前的 SDK 封装逻辑**已经完全支持多设备识别和连接**。

---

## 🔍 多设备工作原理

### 1️⃣ 扫描阶段 - 发现所有设备

```swift
// 开始扫描
BleAPI.shared.scan()
```

**扫描时会发生什么？**
- 扫描到 **每一台** 设备时，`onDeviceFound` 回调就会被调用 **一次**
- 每台设备都有唯一的 `deviceId`（UUID）
- SDK 内部会把所有设备保存在 `scannedDevices` 字典中

**示例场景：**
```
扫描中...
📱 发现设备 1: Air Smart Extra #1 (UUID: xxx-111)
📱 发现设备 2: Air Smart Extra #2 (UUID: xxx-222)  
📱 发现设备 3: Air Smart Extra #3 (UUID: xxx-333)
```

每发现一台，`onDeviceFound` 就会被调用一次，返回：
- `deviceId`: 设备的唯一 ID
- `deviceName`: 设备名称
- `rssi`: 信号强度

---

### 2️⃣ 显示设备列表

在你的 UI 中（TableView / List）显示所有扫描到的设备：

```swift
BleAPI.shared.onDeviceFound = { deviceId, deviceName, rssi in
    // 每扫描到一台设备，这里就会被调用一次
    
    // 创建设备信息
    let device = DeviceInfo(id: deviceId, name: deviceName, rssi: rssi)
    
    // 添加到设备列表
    deviceList.append(device)
    
    // 刷新 UI
    tableView.reloadData()
}
```

**UI 效果：**
```
┌─────────────────────────────────┐
│  选择设备                        │
├─────────────────────────────────┤
│  Air Smart Extra #1  (-65 dBm) │  ← 可点击
│  Air Smart Extra #2  (-72 dBm) │  ← 可点击
│  Air Smart Extra #3  (-58 dBm) │  ← 可点击
└─────────────────────────────────┘
```

---

### 3️⃣ 用户选择并连接

用户点击列表中的某个设备：

```swift
func didSelectDevice(deviceId: String) {
    // 连接用户选择的那台设备
    BleAPI.shared.connect(deviceId: deviceId)
}
```

**SDK 会自动：**
1. ✅ 根据 `deviceId` 找到对应的设备
2. ✅ 连接到该设备
3. ✅ 发现服务和特征
4. ✅ 发送绑定指令
5. ✅ 调用 `onConnected` 回调

---

## 💻 完整代码示例

### 简单版本（直接使用）

```swift
import BleToolsKit

var discoveredDevices: [(id: String, name: String, rssi: Int)] = []

// 1. 设置回调
BleAPI.shared.onDeviceFound = { deviceId, deviceName, rssi in
    // 每扫描到一台设备，这里就会被调用
    print("发现设备: \(deviceName)")
    
    // 保存到列表
    discoveredDevices.append((deviceId, deviceName, rssi))
    
    // 更新 UI（显示设备列表）
    updateDeviceList()
}

BleAPI.shared.onConnected = {
    print("✅ 连接成功！")
}

// 2. 开始扫描
BleAPI.shared.scan()

// 3. 用户点击某个设备时（例如点击第 1 台设备）
func userSelectedDevice(at index: Int) {
    let device = discoveredDevices[index]
    BleAPI.shared.connect(deviceId: device.id)
}
```

---

### UIKit 版本（TableView）

```swift
class DeviceListViewController: UIViewController {
    
    var devices: [(id: String, name: String, rssi: Int)] = []
    @IBOutlet weak var tableView: UITableView!
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupBle()
        BleAPI.shared.scan()  // 开始扫描
    }
    
    func setupBle() {
        // 扫描到设备的回调
        BleAPI.shared.onDeviceFound = { [weak self] deviceId, deviceName, rssi in
            DispatchQueue.main.async {
                // 添加到设备列表
                self?.devices.append((deviceId, deviceName, rssi))
                self?.tableView.reloadData()
            }
        }
        
        // 连接成功的回调
        BleAPI.shared.onConnected = {
            print("✅ 连接成功！")
            // 跳转到控制页面
        }
    }
}

extension DeviceListViewController: UITableViewDelegate, UITableViewDataSource {
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return devices.count
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = tableView.dequeueReusableCell(withIdentifier: "Cell", for: indexPath)
        let device = devices[indexPath.row]
        cell.textLabel?.text = "\(device.name) (\(device.rssi) dBm)"
        return cell
    }
    
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let device = devices[indexPath.row]
        
        // 用户点击了这台设备，连接它
        BleAPI.shared.connect(deviceId: device.id)
    }
}
```

---

### SwiftUI 版本

```swift
import SwiftUI
import BleToolsKit

struct DeviceInfo: Identifiable {
    let id: String
    let name: String
    let rssi: Int
}

class BleViewModel: ObservableObject {
    @Published var devices: [DeviceInfo] = []
    
    init() {
        BleAPI.shared.onDeviceFound = { [weak self] deviceId, deviceName, rssi in
            DispatchQueue.main.async {
                let device = DeviceInfo(id: deviceId, name: deviceName, rssi: rssi)
                self?.devices.append(device)
            }
        }
        
        BleAPI.shared.onConnected = {
            print("✅ 连接成功！")
        }
    }
    
    func startScanning() {
        BleAPI.shared.scan()
    }
    
    func connect(to device: DeviceInfo) {
        BleAPI.shared.connect(deviceId: device.id)
    }
}

struct DeviceListView: View {
    @StateObject var viewModel = BleViewModel()
    
    var body: some View {
        NavigationView {
            List(viewModel.devices) { device in
                Button(action: {
                    // 用户点击了这台设备
                    viewModel.connect(to: device)
                }) {
                    HStack {
                        Text(device.name)
                        Spacer()
                        Text("\(device.rssi) dBm")
                            .foregroundColor(.gray)
                    }
                }
            }
            .navigationTitle("选择设备")
            .onAppear {
                viewModel.startScanning()
            }
        }
    }
}
```

---

## 🎯 关键点总结

### ✅ 多设备支持的证据

| 特性 | 说明 | 支持情况 |
|------|------|---------|
| **扫描多台设备** | 可以扫描到所有附近的设备 | ✅ 完全支持 |
| **设备唯一标识** | 每台设备有唯一的 deviceId (UUID) | ✅ 完全支持 |
| **设备列表存储** | SDK 内部保存所有扫描到的设备 | ✅ 完全支持 |
| **选择性连接** | 可以指定连接某一台设备 | ✅ 完全支持 |
| **设备信息回调** | 每台设备都会触发回调 | ✅ 完全支持 |

---

## 📊 实际场景演示

### 场景：办公室有 3 台 "Air Smart Extra" 设备

```
1. 启动 App，开始扫描
   └─> BleAPI.shared.scan()

2. SDK 扫描到设备
   ├─> 发现设备 1: "Air Smart Extra" (会议室)
   │   └─> 回调: deviceId = "xxxx-1111", name = "Air Smart Extra", rssi = -65
   │
   ├─> 发现设备 2: "Air Smart Extra" (前台)  
   │   └─> 回调: deviceId = "xxxx-2222", name = "Air Smart Extra", rssi = -72
   │
   └─> 发现设备 3: "Air Smart Extra" (老板办公室)
       └─> 回调: deviceId = "xxxx-3333", name = "Air Smart Extra", rssi = -58

3. UI 显示设备列表（3 台设备）
   ┌──────────────────────────────┐
   │ Air Smart Extra  -65 dBm  👈 │ 会议室
   │ Air Smart Extra  -72 dBm     │ 前台
   │ Air Smart Extra  -58 dBm     │ 老板办公室
   └──────────────────────────────┘

4. 用户点击第 1 台（会议室的设备）
   └─> BleAPI.shared.connect(deviceId: "xxxx-1111")

5. SDK 只连接到这一台设备
   └─> 连接成功后调用 onConnected 回调
```

---

## ❓ 常见问题

### Q1: 如果多台设备名称一样怎么办？
**A:** 没问题！设备通过 `deviceId`（UUID）区分，不是通过名称。即使所有设备都叫 "Air Smart Extra"，它们的 UUID 都是唯一的。

### Q2: 如何区分同名设备？
**A:** 可以通过以下方式：
- **信号强度 (rssi)**：离得近的信号强
- **设备 ID 后几位**：显示 UUID 的最后几位
- **连接测试**：先连接看是否是想要的设备

```swift
// 在 UI 上显示更多信息
cell.textLabel?.text = "\(device.name)"
cell.detailTextLabel?.text = "信号: \(device.rssi) dBm | ID: \(device.id.suffix(8))"
```

### Q3: 可以同时连接多台设备吗？
**A:** 当前的封装是单设备连接模式（一次只能连接一台）。如果需要同时连接多台设备，需要对 SDK 进行扩展。

### Q4: 如何让用户重新扫描？
**A:** 提供一个刷新按钮：
```swift
@IBAction func refreshButtonTapped(_ sender: Any) {
    devices.removeAll()
    tableView.reloadData()
    BleAPI.shared.scan()  // 重新扫描
}
```

---

## 🎉 结论

**你的 SDK 已经完美支持多设备！**

- ✅ 扫描时会发现所有设备
- ✅ 每台设备都会触发 `onDeviceFound` 回调
- ✅ 用户可以在列表中选择任意设备
- ✅ 通过 `deviceId` 连接指定设备
- ✅ 完全符合标准的蓝牙多设备管理流程

**你只需要：**
1. 在 UI 上显示设备列表
2. 用户点击时调用 `connect(deviceId:)`
3. 就这么简单！

---

**参考文件：**
- `多设备使用示例.swift` - 完整的代码示例
- `BleAPI.swift` - SDK 核心接口
- `BleCentral.swift` - 底层实现

**最后更新：** 2025-12-04

