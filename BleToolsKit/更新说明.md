# BleToolsKit 更新说明

## 📝 更新内容

### 1. 删除 MAC 地址映射功能 ✅

**删除的文件：**
- `BleMacMapping.swift` - MAC 地址映射管理类

**删除的方法：**
- `BleDataConverter.reversedHexStringFromData()` - MAC 地址转换方法

**原因：** 不再需要保存和判断设备的 MAC 地址

---

### 2. 新增设备名过滤功能 ✅

**新增文件：**
- `BleDeviceNameFilter.swift` - 设备名称过滤类

**功能说明：**
- 只扫描设备名包含 "Air Smart Extra" 的设备
- 提供 `isTargetDevice()` 方法判断设备是否匹配

**使用方式：**
```swift
if BleDeviceNameFilter.shared.isTargetDevice(peripheral: peripheral) {
    // 这是目标设备
}
```

---

### 3. 增强 DataConverter 数据转换类 ✅

**新增方法：**

#### 3.1 CRC 校验值计算
```swift
static func calculateCRC(from hexString: String) -> String
```
- **功能：** 计算十六进制字符串的 CRC 校验值
- **算法：** 将每两位十六进制相加，取最后两位作为校验值
- **示例：**
  ```swift
  let crc = DataConverter.calculateCRC(from: "88dd1E00")
  // 返回: "05"（示例）
  ```

#### 3.2 十六进制字符串转 Data
```swift
static func dataWithHexString(_ hexString: String) -> Data
```
- **功能：** 将十六进制字符串转换为 Data 类型
- **示例：**
  ```swift
  let data = DataConverter.dataWithHexString("0102FF")
  ```

---

### 4. 升级 BleCentral 蓝牙中心类 ✅

#### 4.1 服务过滤
**实现逻辑：**
- 在 `didDiscoverServices` 中过滤服务 UUID **"1000"**
- 只处理包含目标服务的设备

```swift
private let targetServiceUUID = CBUUID(string: "1000")
```

#### 4.2 特征识别
**实现逻辑：**
- 在 `didDiscoverCharacteristicsFor` 中识别两个特征：
  - **"1001"** - 写入特征（Write）
  - **"1002"** - 通知特征（Notify/Read）

```swift
private let writeCharUUID = CBUUID(string: "1001")
private let notifyCharUUID = CBUUID(string: "1002")
```

#### 4.3 自动启用通知
**实现逻辑：**
- 发现 "1002" 特征后，自动调用 `setNotifyValue(true)`
- 启用数据通知功能

#### 4.4 自动发送绑定指令 🔥
**实现逻辑：**
- 发现特征后延迟 **0.2 秒**自动发送绑定指令
- 指令格式：`88dd1E00000000000000000000000000000000` + CRC校验值

**代码流程：**
```swift
private func sendBindCommand() {
    // 1. 构建指令
    let commandString = "88dd1E00000000000000000000000000000000"
    
    // 2. 计算 CRC 校验值
    let crc = DataConverter.calculateCRC(from: commandString)
    
    // 3. 完整指令
    let fullCommand = commandString + crc
    
    // 4. 转换为 Data
    let commandData = DataConverter.dataWithHexString(fullCommand)
    
    // 5. 写入数据
    peripheral.writeValue(commandData, for: writeChar, type: .withResponse)
}
```

---

## 🚀 使用流程

### 完整工作流程

```
1. 扫描设备
   ↓
   只返回设备名包含 "Air Smart Extra" 的设备
   
2. 用户选择设备并连接
   ↓
   调用 BleAPI.shared.connect(deviceId:)
   
3. 自动发现服务 "1000"
   ↓
   过滤并验证目标服务
   
4. 自动发现特征 "1001" 和 "1002"
   ↓
   - "1001" 保存为写特征
   - "1002" 保存为通知特征并启用通知
   
5. 延迟 0.2 秒后自动发送绑定指令
   ↓
   指令: 88dd1E00000000000000000000000000000000 + CRC
   
6. 开始正常通信
   ↓
   - 通过 "1001" 写入数据
   - 通过 "1002" 接收数据
```

---

## 📋 代码示例

### 基础使用
```swift
import BleToolsKit

// 1. 配置连接超时（可选，默认 10 秒）
BleAPI.shared.timeout = 10

// 注意：服务和特征 UUID 已内部硬编码
// 服务: "1000", 特征: "1001"(写), "1002"(读)

// 2. 设置回调
BleAPI.shared.onDeviceFound = { deviceId, deviceName, rssi in
    print("发现设备: \(deviceName)")
}

BleAPI.shared.onConnected = {
    print("连接成功，已自动发送绑定指令")
}

BleAPI.shared.onDataReceived = { hexString in
    print("收到数据: \(hexString)")
}

// 3. 开始扫描
BleAPI.shared.scan()

// 4. 连接设备
BleAPI.shared.connect(deviceId: "设备ID")

// 5. 发送数据
BleAPI.shared.send("0102FF")
```

---

## 🔍 调试信息

在 DEBUG 模式下，会输出详细的日志信息：

```
✅ 发现目标设备: Air Smart Extra
✅ 找到目标服务: 1000
✅ 找到写特征: 1001
✅ 找到通知特征: 1002
✅ 发送绑定指令: 88dd1E00000000000000000000000000000000XX
✅ 指令数据: <88dd1e00 00000000 00000000 00000000 000000XX>
```

---

## ⚠️ 注意事项

1. **服务 UUID 必须为 "1000"**
   - 如果设备不包含此服务，连接会失败

2. **特征 UUID 必须为 "1001" 和 "1002"**
   - "1001" 用于写入数据
   - "1002" 用于接收数据（必须支持 Notify）

3. **自动发送绑定指令**
   - 连接成功后自动发送，无需手动调用
   - 延迟 0.2 秒确保特征准备就绪

4. **CRC 校验值**
   - 自动计算并追加到指令末尾
   - 算法：累加所有字节，取最后两位十六进制

---

## 📚 相关文件

- `BleToolsKit/BleCentral.swift` - 蓝牙中心管理类（核心逻辑）
- `BleToolsKit/DataConverter.swift` - 数据转换工具类
- `BleToolsKit/BleDeviceNameFilter.swift` - 设备名过滤类
- `BleToolsKit/BleAPI.swift` - 对外 API 接口
- `使用示例_更新版.swift` - 完整使用示例
- `DataConverterTest.swift` - 数据转换测试

---

## ✅ 测试建议

### 1. 测试 CRC 计算
运行 `DataConverterTest.swift` 验证 CRC 计算是否正确

### 2. 测试扫描过滤
确保只扫描到 "Air Smart Extra" 设备

### 3. 测试自动绑定
连接成功后检查日志，确认绑定指令已发送

### 4. 测试数据通信
发送和接收数据，验证 "1001" 和 "1002" 特征工作正常

---

## 🎯 下一步优化建议

1. 将服务和特征 UUID 改为可配置参数
2. 将绑定指令改为可配置参数
3. 添加绑定指令发送成功/失败的回调
4. 添加设备断开连接的自动重连机制
5. 添加数据发送队列管理

---

**更新日期：** 2025-12-04
**版本：** 2.0

