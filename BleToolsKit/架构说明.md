# BleToolsKit æ¶æ„è¯´æ˜

## ğŸ“ æ–‡ä»¶ç»“æ„ï¼ˆç²¾ç®€åï¼‰

```
BleToolsKit/
â”œâ”€â”€ BleAPI.swift          â­ï¸ å¯¹å¤–æ¥å£å±‚ï¼ˆ174è¡Œï¼‰
â”œâ”€â”€ BleCentral.swift      ğŸ”§ åº•å±‚å°è£…å±‚ï¼ˆ350è¡Œï¼‰  
â””â”€â”€ BlePublic.swift       ğŸ“¦ æ•°æ®ç»“æ„å±‚ï¼ˆ54è¡Œï¼‰
```

æ€»å…±ï¼š**3ä¸ªæ–‡ä»¶ï¼Œ578è¡Œä»£ç **

---

## ğŸ—ï¸ ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BleAPI (å¯¹å¤–æ¥å£å±‚)                 â”‚  â† å¤–éƒ¨è°ƒç”¨
â”‚   - scan()                          â”‚
â”‚   - connect(deviceId:)              â”‚
â”‚   - send(_:)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   BleCentral (åº•å±‚å°è£…å±‚)             â”‚  â† å†…éƒ¨å®ç°
â”‚   - startScan()                     â”‚
â”‚   - connect(_:timeout:)             â”‚
â”‚   - write(data:to:)                 â”‚
â”‚   - setNotify(_:for:)               â”‚
â”‚   - discoverCharacteristics()       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   BlePublic (æ•°æ®ç»“æ„å±‚)              â”‚  â† å†…éƒ¨æ•°æ®
â”‚   - BleDevice                       â”‚
â”‚   - BleFilter                       â”‚
â”‚   - BleError                        â”‚
â”‚   - ScanToken                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   CoreBluetooth (iOSç³»ç»Ÿæ¡†æ¶)        â”‚  â† ç³»ç»Ÿå±‚
â”‚   - CBCentralManager                â”‚
â”‚   - CBPeripheral                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ å„å±‚èŒè´£

### ç¬¬ä¸€å±‚ï¼šBleAPI.swiftï¼ˆå¯¹å¤–æ¥å£å±‚ï¼‰

**èŒè´£**ï¼šæä¾›ç®€å•æ˜“ç”¨çš„å…¬å¼€API

```swift
public class BleAPI {
    // å¯¹å¤–æš´éœ²çš„3ä¸ªæ–¹æ³•
    public func scan()
    public func connect(deviceId: String)
    public func send(_ hexString: String)
    
    // å†…éƒ¨å®ç°
    private let central = BleCentral.shared  // è°ƒç”¨åº•å±‚
    private var scannedDevices: [String: BleDevice] = [:]
    
    // è‡ªåŠ¨å¤„ç†ï¼š
    // âœ… UUIDå­—ç¬¦ä¸² â†’ CBUUIDè½¬æ¢
    // âœ… è®¾å¤‡åˆ—è¡¨ç®¡ç†
    // âœ… è‡ªåŠ¨è®¢é˜…é€šçŸ¥ç‰¹å¾
    // âœ… è‡ªåŠ¨é€‰æ‹©å¯å†™ç‰¹å¾
    // âœ… Data â†” åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢
}
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€å±‚ï¼Ÿ**
- ç®€åŒ–æ¥å£ï¼š3ä¸ªæ–¹æ³•å®Œæˆæ‰€æœ‰æ“ä½œ
- è‡ªåŠ¨å¤„ç†ï¼šUUIDè½¬æ¢ã€è®¾å¤‡ç®¡ç†ã€ç‰¹å¾é€‰æ‹©
- ç”¨æˆ·å‹å¥½ï¼šå›è°ƒç®€å•ï¼Œæ•°æ®æ ¼å¼ç»Ÿä¸€ï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰

---

### ç¬¬äºŒå±‚ï¼šBleCentral.swiftï¼ˆåº•å±‚å°è£…å±‚ï¼‰

**èŒè´£**ï¼šå°è£…CoreBluetoothçš„å¤æ‚å›è°ƒæœºåˆ¶

```swift
internal class BleCentral: NSObject, 
    CBCentralManagerDelegate,      // å¤„ç†è“ç‰™çŠ¶æ€
    CBPeripheralDelegate {          // å¤„ç†è®¾å¤‡å›è°ƒ
    
    private var central: CBCentralManager!
    
    // æä¾›æ›´å‹å¥½çš„æ¥å£
    internal func startScan(filter: BleFilter, 
                           onFound: @escaping (BleDevice) -> Void,
                           onError: @escaping (Error) -> Void)
    
    internal func connect(_ device: BleDevice,
                         timeout: TimeInterval,
                         onReady: @escaping (CBPeripheral) -> Void,
                         onError: @escaping (Error) -> Void)
    
    internal func write(data: Data, 
                       to characteristic: CBCharacteristic,
                       onError: @escaping (Error) -> Void)
    
    // å¤„ç†ç³»ç»Ÿå›è°ƒ
    func centralManagerDidUpdateState(_ central: CBCentralManager)
    func centralManager(_ central: CBCentralManager, 
                       didDiscover peripheral: CBPeripheral, ...)
    func peripheral(_ peripheral: CBPeripheral, 
                   didDiscoverServices error: Error?)
}
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€å±‚ï¼Ÿ**
- å°è£…å¤æ‚æ€§ï¼šå°†delegateå›è°ƒè½¬ä¸ºé—­åŒ…
- ç»Ÿä¸€ç®¡ç†ï¼šé›†ä¸­å¤„ç†è“ç‰™çŠ¶æ€å’Œè¿æ¥
- å¯å¤ç”¨ï¼šå¦‚æœä»¥åè¦æ‰©å±•åŠŸèƒ½ï¼Œåªåœ¨è¿™å±‚ä¿®æ”¹

---

### ç¬¬ä¸‰å±‚ï¼šBlePublic.swiftï¼ˆæ•°æ®ç»“æ„å±‚ï¼‰

**èŒè´£**ï¼šå®šä¹‰å†…éƒ¨ä½¿ç”¨çš„æ•°æ®ç»“æ„

```swift
// è®¾å¤‡ä¿¡æ¯
internal struct BleDevice {
    let peripheral: CBPeripheral
    let name: String
    let identifier: String
    let rssi: Int
}

// æ‰«æè¿‡æ»¤å™¨
internal struct BleFilter {
    let serviceUUIDs: [CBUUID]?
    let allowDuplicates: Bool
}

// é”™è¯¯ç±»å‹
internal enum BleError: LocalizedError {
    case unsupported, unauthorized, poweredOff
    case timeout, disconnected, unknown
}

// æ‰«æä»¤ç‰Œ
internal protocol ScanToken {
    func stop()
}
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€å±‚ï¼Ÿ**
- ç±»å‹å®‰å…¨ï¼šç»Ÿä¸€çš„æ•°æ®ç»“æ„
- ä»£ç ç»„ç»‡ï¼šæ•°æ®å’Œé€»è¾‘åˆ†ç¦»
- æ˜“äºç»´æŠ¤ï¼šä¿®æ”¹ç»“æ„ä¸å½±å“é€»è¾‘

---

## ğŸ”„ è°ƒç”¨æµç¨‹ç¤ºä¾‹

### ç”¨æˆ·è°ƒç”¨ scan()

```
å¤–éƒ¨è°ƒç”¨:
BleAPI.shared.scan()
    â†“
BleAPI å¤„ç†:
- è½¬æ¢ serviceUUIDs: [String]? â†’ [CBUUID]?
- åˆ›å»º BleFilter
    â†“
è°ƒç”¨åº•å±‚:
BleCentral.shared.startScan(filter:onFound:onError:)
    â†“
BleCentral å¤„ç†:
- æ£€æŸ¥è“ç‰™çŠ¶æ€
- è°ƒç”¨ central.scanForPeripherals()
- æ¥æ”¶ delegate å›è°ƒ
    â†“
è¿”å›æ•°æ®:
BleCentral â†’ BleDevice â†’ BleAPI
    â†“
è½¬æ¢æ•°æ®:
BleAPI å°† BleDevice è½¬ä¸º (String, String, Int)
    â†“
å›è°ƒç”¨æˆ·:
onDeviceFound?(deviceId, name, rssi)
```

---

## â“ ä¸ºä»€ä¹ˆä¸åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼Ÿ

### åˆ†å±‚çš„å¥½å¤„ï¼š

1. **èŒè´£æ¸…æ™°**
   - BleAPIï¼šå¯¹å¤–æ¥å£
   - BleCentralï¼šåº•å±‚é€»è¾‘
   - BlePublicï¼šæ•°æ®å®šä¹‰

2. **æ˜“äºç»´æŠ¤**
   - ä¿®æ”¹å¯¹å¤–æ¥å£ä¸å½±å“åº•å±‚
   - ä¿®æ”¹åº•å±‚å®ç°ä¸å½±å“æ¥å£
   - æ•°æ®ç»“æ„ç‹¬ç«‹ç®¡ç†

3. **è®¿é—®æ§åˆ¶**
   - BleAPI: `public` - å¤–éƒ¨å¯è§
   - BleCentral: `internal` - ä»…SDKå†…éƒ¨
   - BlePublic: `internal` - ä»…SDKå†…éƒ¨

4. **ä»£ç å¯è¯»æ€§**
   - æ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€
   - ä»£ç é‡é€‚ä¸­ï¼ˆ50-350è¡Œï¼‰
   - æ˜“äºç†è§£å’Œä¿®æ”¹

---

## âœ… ä¼˜åŒ–åçš„ä¼˜ç‚¹

### åˆ é™¤äº†å†—ä½™çš„ BleToolsKit.swift

**ä¹‹å‰ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰ï¼š**
```swift
// ç”¨æˆ·ä½¿ç”¨
BleToolsKit.shared â†’ BleAPI.shared  // å¤šä½™çš„è½¬å‘
```

**ç°åœ¨ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰ï¼š**
```swift
// ç”¨æˆ·ç›´æ¥ä½¿ç”¨
BleAPI.shared  // ç›´æ¥è®¿é—®ï¼Œæ›´æ¸…æ™°
```

### æ¯ä¸ªæ–‡ä»¶çš„å¿…è¦æ€§ï¼š

| æ–‡ä»¶ | èŒè´£ | èƒ½å¦åˆ é™¤ | åŸå›  |
|-----|------|---------|------|
| BleAPI.swift | å¯¹å¤–æ¥å£ | âŒ ä¸èƒ½ | SDKå”¯ä¸€å¯¹å¤–å…¥å£ |
| BleCentral.swift | åº•å±‚å°è£… | âŒ ä¸èƒ½ | å°è£…CoreBluetooth |
| BlePublic.swift | æ•°æ®ç»“æ„ | âš ï¸ ç†è®ºå¯ä»¥ | ä½†ä¼šé™ä½å¯è¯»æ€§ |

**BlePublic.swift ä¿ç•™çš„åŸå› ï¼š**
- æ•°æ®ç»“æ„å®šä¹‰é›†ä¸­ç®¡ç†
- ä¿æŒæ–‡ä»¶ä»£ç é‡é€‚ä¸­
- æé«˜ä»£ç å¯ç»´æŠ¤æ€§

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

```
BleAPI.swift        174è¡Œ  (å¯¹å¤–æ¥å£ + è‡ªåŠ¨å¤„ç†é€»è¾‘)
BleCentral.swift    350è¡Œ  (åº•å±‚å°è£… + CoreBluetooth delegate)
BlePublic.swift      54è¡Œ  (æ•°æ®ç»“æ„å®šä¹‰)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡                578è¡Œ
```

**å¯¹æ¯”ä¸šç•Œæ ‡å‡†ï¼š**
- âœ… ä»£ç ç®€æ´ï¼ˆ< 1000è¡Œï¼‰
- âœ… æ–‡ä»¶åˆ†å±‚æ¸…æ™°
- âœ… èŒè´£å•ä¸€
- âœ… æ— é‡å¤ä»£ç 

---

## ğŸ¯ æ€»ç»“

### ä¸‰ä¸ªæ–‡ä»¶ï¼Œä¸‰ä¸ªèŒè´£ï¼š

1. **BleAPI.swift** = å¤–éƒ¨æ¥å£ï¼ˆç®€å•æ˜“ç”¨ï¼‰
2. **BleCentral.swift** = å†…éƒ¨å®ç°ï¼ˆå°è£…å¤æ‚æ€§ï¼‰
3. **BlePublic.swift** = æ•°æ®å®šä¹‰ï¼ˆç±»å‹å®‰å…¨ï¼‰

### æ— é‡å¤å®ç°ï¼š

- âœ… BleAPI è°ƒç”¨ BleCentralï¼ˆæ²¡æœ‰é‡å¤é€»è¾‘ï¼‰
- âœ… BleCentral å°è£… CoreBluetoothï¼ˆæ²¡æœ‰é‡å¤é€»è¾‘ï¼‰
- âœ… BlePublic åªå®šä¹‰æ•°æ®ï¼ˆæ²¡æœ‰é€»è¾‘ä»£ç ï¼‰

### æ¶æ„åˆç†ï¼š

- âœ… åˆ†å±‚æ¸…æ™°
- âœ… èŒè´£å•ä¸€
- âœ… æ˜“äºç»´æŠ¤
- âœ… ç¬¦åˆSOLIDåŸåˆ™

